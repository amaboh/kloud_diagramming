<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Diagrams TS - Advanced Layout & Groups</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .features {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .features h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 2rem;
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .feature-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .feature-card h3 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .feature-card p {
        color: #666;
        font-size: 0.95rem;
      }

      .demo-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .demo-section h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 2rem;
      }

      .controls {
        margin-bottom: 20px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.secondary {
        background: linear-gradient(45deg, #28a745, #20c997);
      }

      .btn.info {
        background: linear-gradient(45deg, #17a2b8, #6f42c1);
      }

      .btn.warning {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
      }

      #advanced-diagram {
        width: 100%;
        min-height: 800px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        background: #fafafa;
        overflow: auto;
        margin-bottom: 20px;
      }

      .layout-demo {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .layout-container {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        background: #fafafa;
        min-height: 300px;
      }

      .layout-container h3 {
        color: #667eea;
        margin-bottom: 15px;
        text-align: center;
      }

      .status {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        color: #2e7d32;
      }

      .info-panel {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
      }

      .architecture-showcase {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        align-items: start;
      }

      .diagram-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
      }

      .diagram-info h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .diagram-info ul {
        list-style: none;
        padding: 0;
      }

      .diagram-info li {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.9rem;
      }

      .diagram-info li:last-child {
        border-bottom: none;
      }

      .group-styles {
        margin-top: 20px;
      }

      .group-styles h4 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .group-legend {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }

      .group-legend-item {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
      }

      .group-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        margin-right: 8px;
      }

      .vpc-style {
        background-color: #232f3e;
      }
      .subnet-style {
        background-color: #ff9900;
      }
      .az-style {
        background-color: #146eb4;
      }
      .db-style {
        background-color: #9d5025;
      }

      /* AWS service specific styling */
      .aws-ec2 text {
        fill: #f58536 !important;
      }
      .aws-lambda text {
        fill: #f58536 !important;
      }
      .aws-rds text {
        fill: #3c4b99 !important;
      }
      .aws-dynamodb text {
        fill: #3c4b99 !important;
      }
      .aws-s3 text {
        fill: #3f9c59 !important;
      }
      .aws-vpc text {
        fill: #8c4fff !important;
      }
      .aws-route53 text {
        fill: #8c4fff !important;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        header h1 {
          font-size: 2rem;
        }

        .feature-grid {
          grid-template-columns: 1fr;
        }

        .architecture-showcase {
          grid-template-columns: 1fr;
        }

        .layout-demo {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üèóÔ∏è Advanced Layout & Groups</h1>
        <p>
          Enhanced group management and layout algorithms for professional cloud
          architecture diagrams
        </p>
      </header>

      <div class="features">
        <h2>üöÄ Priority 2: Advanced Layout & Group Features</h2>
        <div class="feature-grid">
          <div class="feature-card">
            <h3>üè¢ Enhanced Groups</h3>
            <p>
              Proper node-to-group assignment with nested subgroups (VPC ‚Üí
              Subnets ‚Üí AZs) and visual containers.
            </p>
          </div>
          <div class="feature-card">
            <h3>üìê Advanced Layout Options</h3>
            <p>
              Multiple layout algorithms: auto, hierarchical, manual positioning
              with intelligent spacing.
            </p>
          </div>
          <div class="feature-card">
            <h3>üéØ Manual Positioning</h3>
            <p>
              Precise node positioning control with fixed coordinates and custom
              spacing options.
            </p>
          </div>
          <div class="feature-card">
            <h3>üìä Hierarchical Layouts</h3>
            <p>
              Multi-level group hierarchies with proper visual nesting and
              automatic layout optimization.
            </p>
          </div>
          <div class="feature-card">
            <h3>üé® Group Styling</h3>
            <p>
              AWS-specific group styles (VPC, Subnet, AZ) with proper colors and
              visual differentiation.
            </p>
          </div>
          <div class="feature-card">
            <h3>üîç Group Analytics</h3>
            <p>
              Comprehensive group statistics and analysis for understanding
              diagram complexity.
            </p>
          </div>
        </div>
      </div>

      <div class="demo-section">
        <h2>üéØ Advanced AWS Architecture Demo</h2>
        <div class="controls">
          <button class="btn" onclick="renderAdvancedDemo()">
            üèóÔ∏è Render Advanced Architecture
          </button>
          <button class="btn secondary" onclick="showGroupStatistics()">
            üìä Show Group Statistics
          </button>
          <button class="btn info" onclick="demonstrateLayoutAlgorithms()">
            üìê Compare Layouts
          </button>
          <button class="btn warning" onclick="toggleManualPositioning()">
            üéØ Toggle Manual Positioning
          </button>
          <button class="btn" onclick="exportDiagram('svg')">
            üì• Export SVG
          </button>
        </div>

        <div class="info-panel">
          <strong>üèóÔ∏è Advanced Architecture Features:</strong>
          <ul>
            <li>
              <strong>Multi-Tier Architecture:</strong> Web, Application, and
              Database tiers with proper separation
            </li>
            <li>
              <strong>Nested Groups:</strong> VPC ‚Üí Subnets ‚Üí Availability Zones
              hierarchy
            </li>
            <li>
              <strong>Cross-AZ Deployment:</strong> High availability with
              multiple AZ deployment
            </li>
            <li>
              <strong>Advanced Connections:</strong> Enhanced metadata and
              connection styling
            </li>
            <li>
              <strong>Group Statistics:</strong> Real-time analysis of group
              complexity and structure
            </li>
          </ul>
        </div>

        <div class="architecture-showcase">
          <div id="advanced-diagram">
            <div style="text-align: center; padding: 80px; color: #666">
              <h3>üèóÔ∏è Advanced AWS Multi-Tier Architecture</h3>
              <p>
                Click "Render Advanced Architecture" to see the enhanced group
                management system!
              </p>
              <br />
              <div class="group-styles">
                <h4>Group Style Legend:</h4>
                <div class="group-legend">
                  <div class="group-legend-item">
                    <div class="group-color vpc-style"></div>
                    VPC
                  </div>
                  <div class="group-legend-item">
                    <div class="group-color subnet-style"></div>
                    Public Subnet
                  </div>
                  <div class="group-legend-item">
                    <div class="group-color az-style"></div>
                    Private Subnet
                  </div>
                  <div class="group-legend-item">
                    <div class="group-color db-style"></div>
                    DB Subnet
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="diagram-info">
            <h3>üèóÔ∏è Architecture Components</h3>
            <ul id="architecture-components">
              <li><strong>Production VPC:</strong> Main network container</li>
              <li><strong>Public Subnet:</strong> Web tier (Multi-AZ)</li>
              <li><strong>Private Subnet:</strong> Application tier</li>
              <li><strong>Database Subnet:</strong> Data tier</li>
              <li><strong>External Storage:</strong> S3 buckets</li>
            </ul>

            <div class="group-styles">
              <h4>üìä Group Statistics</h4>
              <div id="group-stats">
                <div class="stat-card">
                  <div class="stat-number">-</div>
                  <div class="stat-label">Total Groups</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number">-</div>
                  <div class="stat-label">Nested Levels</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="status-panel"></div>
      </div>

      <div class="demo-section">
        <h2>üìê Layout Algorithm Comparison</h2>
        <div class="info-panel">
          <strong>üí° Layout Algorithms:</strong> Compare different automatic
          layout algorithms and manual positioning options.
        </div>
        <div class="layout-demo" id="layout-comparison">
          <div class="layout-container">
            <h3>üîÑ Auto Layout</h3>
            <div id="auto-layout" style="height: 250px">
              <p style="text-align: center; padding: 50px; color: #666">
                Click "Compare Layouts" to see algorithm differences
              </p>
            </div>
          </div>
          <div class="layout-container">
            <h3>üìä Hierarchical Layout</h3>
            <div id="hierarchical-layout" style="height: 250px">
              <p style="text-align: center; padding: 50px; color: #666">
                Structured hierarchy with level-based spacing
              </p>
            </div>
          </div>
          <div class="layout-container">
            <h3>üéØ Manual Layout</h3>
            <div id="manual-layout" style="height: 250px">
              <p style="text-align: center; padding: 50px; color: #666">
                Precise positioning with fixed coordinates
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Load the cloud-diagrams library -->
    <script type="module">
      import { Diagram, iconRegistry } from '../../packages/core/dist/index.js';
      import {
        EC2,
        RDS,
        S3,
        Lambda,
        DynamoDB,
      } from '../../packages/aws/dist/index.js';

      let currentDiagram = null;
      let currentLayoutAlgorithm = 'hierarchical';

      // Global functions for demo controls
      window.renderAdvancedDemo = async function () {
        try {
          showStatus(
            'üöÄ Creating advanced AWS multi-tier architecture...',
            'info'
          );

          // Create the advanced diagram with enhanced groups
          const diagram = new Diagram(
            'Advanced AWS Multi-Tier Architecture',
            {
              direction: 'LR',
              theme: 'default',
            },
            {
              algorithm: currentLayoutAlgorithm,
              spacing: {
                node: 60,
                group: 100,
                level: 150,
              },
              alignment: 'center',
            }
          );

          // Create VPC group with AWS-specific styling
          const vpc = diagram.addGroup(
            'Production VPC',
            undefined,
            {
              description: 'Main production VPC with multi-AZ deployment',
              style: 'vpc',
              color: '#232F3E',
            },
            {
              direction: 'LR',
              spacing: 80,
              padding: 30,
            }
          );

          // Create subnet groups
          const publicSubnet = diagram.addGroup('Public Subnet', undefined, {
            description: 'Public subnet for web tier',
            style: 'subnet',
            color: '#FF9900',
          });

          const privateSubnet = diagram.addGroup('Private Subnet', undefined, {
            description: 'Private subnet for application tier',
            style: 'subnet',
            color: '#146EB4',
          });

          const dbSubnet = diagram.addGroup('Database Subnet', undefined, {
            description: 'Database subnet for data tier',
            style: 'subnet',
            color: '#9D5025',
          });

          // Create nested AZ groups
          const az1 = diagram.createNestedGroup(publicSubnet.id, 'AZ-1a', {
            description: 'Availability Zone 1a',
            style: 'availability-zone',
          });

          const az2 = diagram.createNestedGroup(publicSubnet.id, 'AZ-1b', {
            description: 'Availability Zone 1b',
            style: 'availability-zone',
          });

          // Add web tier in AZs
          const webServer1 = az1.addNode(
            new EC2('web-server-1', {
              metadata: {
                description: 'Primary web server in AZ-1a',
                url: 'https://console.aws.amazon.com/ec2/',
                availabilityZone: 'us-east-1a',
              },
            })
          );

          const webServer2 = az2.addNode(
            new EC2('web-server-2', {
              metadata: {
                description: 'Secondary web server in AZ-1b',
                url: 'https://console.aws.amazon.com/ec2/',
                availabilityZone: 'us-east-1b',
              },
            })
          );

          // Add application tier
          const apiLambda = privateSubnet.addNode(
            new Lambda('api-lambda', {
              metadata: {
                description: 'Main API processing Lambda',
                url: 'https://console.aws.amazon.com/lambda/',
              },
            })
          );

          const authLambda = privateSubnet.addNode(
            new Lambda('auth-lambda', {
              metadata: {
                description: 'Authentication service Lambda',
                url: 'https://console.aws.amazon.com/lambda/',
              },
            })
          );

          // Add data tier
          const userDb = dbSubnet.addNode(
            new RDS('user-db', {
              metadata: {
                description: 'Primary user database with Multi-AZ',
                url: 'https://console.aws.amazon.com/rds/',
              },
            })
          );

          const sessionStore = dbSubnet.addNode(
            new DynamoDB('session-store', {
              metadata: {
                description: 'User session storage',
                url: 'https://console.aws.amazon.com/dynamodb/',
              },
            })
          );

          // Add external storage
          const assetsBucket = diagram.addNode(
            new S3('assets-bucket', {
              metadata: {
                description: 'Static assets and uploads',
                url: 'https://console.aws.amazon.com/s3/',
              },
            })
          );

          // Create connections
          diagram.connect(webServer1, apiLambda, {
            label: 'HTTPS API',
            style: 'solid',
          });
          diagram.connect(webServer2, apiLambda, {
            label: 'HTTPS API',
            style: 'solid',
          });
          diagram.connect(apiLambda, authLambda, {
            label: 'Auth Check',
            style: 'dashed',
          });
          diagram.connect(apiLambda, userDb, { label: 'SQL', style: 'solid' });
          diagram.connect(authLambda, sessionStore, {
            label: 'Session Data',
            style: 'solid',
          });
          diagram.connect(webServer1, assetsBucket, {
            label: 'Assets',
            style: 'dotted',
          });

          currentDiagram = diagram;

          // Render the diagram
          const container = document.getElementById('advanced-diagram');
          await diagram.render(container, {
            theme: 'default',
            interactive: true,
            layoutAlgorithm: currentLayoutAlgorithm,
          });

          // Update architecture info
          updateArchitectureInfo(diagram);

          // Add enhanced click handler
          container.addEventListener('nodeClick', (event) => {
            const { node } = event.detail;
            if (node.metadata?.url) {
              const shouldOpen = confirm(`Open ${node.label} in AWS Console?`);
              if (shouldOpen) {
                window.open(node.metadata.url, '_blank');
              }
            }
          });

          showStatus(
            '‚úÖ Advanced architecture rendered successfully!',
            'success'
          );
        } catch (error) {
          console.error('Rendering error:', error);
          showStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      };

      window.showGroupStatistics = function () {
        if (!currentDiagram) {
          showStatus('‚ö†Ô∏è Please render a diagram first', 'warning');
          return;
        }

        const stats = currentDiagram.getGroupStatistics();
        updateGroupStatistics(stats);

        showStatus('üìä Group statistics updated!', 'info');
      };

      window.demonstrateLayoutAlgorithms = async function () {
        try {
          showStatus('üî¨ Demonstrating layout algorithms...', 'info');

          // Create sample diagrams for each algorithm
          const createSampleDiagram = (algorithm, title) => {
            const diagram = new Diagram(
              title,
              { direction: 'LR' },
              {
                algorithm: algorithm,
                spacing: { node: 50, group: 80 },
              }
            );

            const webServer = diagram.addNode(new EC2('web-server'));
            const apiServer = diagram.addNode(new Lambda('api-service'));
            const database = diagram.addNode(new RDS('database'));

            if (algorithm === 'manual') {
              diagram.positionNode(webServer.id, 100, 100, true);
              diagram.positionNode(apiServer.id, 300, 100, true);
              diagram.positionNode(database.id, 500, 100, true);
            }

            diagram.connect(webServer, apiServer);
            diagram.connect(apiServer, database);

            return diagram;
          };

          const autoLayoutDiagram = createSampleDiagram('auto', 'Auto Layout');
          const hierarchicalDiagram = createSampleDiagram(
            'hierarchical',
            'Hierarchical Layout'
          );
          const manualDiagram = createSampleDiagram('manual', 'Manual Layout');

          // Render each diagram
          await autoLayoutDiagram.render('auto-layout', {
            theme: 'default',
            interactive: false,
            width: 450,
            height: 200,
          });

          await hierarchicalDiagram.render('hierarchical-layout', {
            theme: 'default',
            interactive: false,
            width: 450,
            height: 200,
          });

          await manualDiagram.render('manual-layout', {
            theme: 'default',
            interactive: false,
            width: 450,
            height: 200,
          });

          showStatus('‚úÖ Layout algorithm comparison complete!', 'success');
        } catch (error) {
          showStatus(`‚ùå Layout demo failed: ${error.message}`, 'error');
        }
      };

      window.toggleManualPositioning = function () {
        currentLayoutAlgorithm =
          currentLayoutAlgorithm === 'manual' ? 'hierarchical' : 'manual';
        showStatus(`üéØ Switched to ${currentLayoutAlgorithm} layout`, 'info');

        if (currentDiagram) {
          window.renderAdvancedDemo();
        }
      };

      window.exportDiagram = async function (format) {
        if (!currentDiagram) {
          showStatus('‚ö†Ô∏è Please render a diagram first', 'warning');
          return;
        }

        try {
          showStatus(
            `üì• Exporting diagram as ${format.toUpperCase()}...`,
            'info'
          );

          const blob = await currentDiagram.export(format);
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `advanced-aws-architecture.${format}`;
          link.click();

          showStatus(
            `‚úÖ Diagram exported as ${format.toUpperCase()}!`,
            'success'
          );
        } catch (error) {
          showStatus(`‚ùå Export failed: ${error.message}`, 'error');
        }
      };

      function updateArchitectureInfo(diagram) {
        const stats = diagram.getGroupStatistics();

        const components = [
          `<strong>Production VPC:</strong> Main network container (${stats.totalGroups} groups)`,
          `<strong>Multi-AZ Setup:</strong> High availability across ${stats.maxGroupDepth} levels`,
          `<strong>Web Tier:</strong> Load balanced EC2 instances`,
          `<strong>App Tier:</strong> Serverless Lambda functions`,
          `<strong>Data Tier:</strong> RDS + DynamoDB storage`,
          `<strong>Total Nodes:</strong> ${stats.totalNodes} services`,
        ];

        document.getElementById('architecture-components').innerHTML =
          components.map((comp) => `<li>${comp}</li>`).join('');
      }

      function updateGroupStatistics(stats) {
        const statsContainer = document.getElementById('group-stats');
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${stats.totalGroups}</div>
            <div class="stat-label">Total Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.maxGroupDepth}</div>
            <div class="stat-label">Max Depth</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.nodesInGroups}</div>
            <div class="stat-label">Nodes in Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${stats.ungroupedNodes}</div>
            <div class="stat-label">Ungrouped</div>
          </div>
        `;
      }

      function showStatus(message, type = 'info', extraContent = '') {
        const panel = document.getElementById('status-panel');
        const colors = {
          info: '#0ea5e9',
          success: '#22c55e',
          warning: '#f59e0b',
          error: '#ef4444',
        };

        panel.innerHTML = `
          <div style="background: ${colors[type]}20; border: 1px solid ${colors[type]}; 
                     border-radius: 8px; padding: 15px; margin: 20px 0; color: ${colors[type]};">
            <strong>${message}</strong>
            ${extraContent}
          </div>
        `;
      }

      // Initialize demo
      document.addEventListener('DOMContentLoaded', async () => {
        showStatus('üèóÔ∏è Advanced Layout & Groups Demo Ready!', 'info');

        // Auto-render the advanced demo
        await window.renderAdvancedDemo();
        await window.demonstrateLayoutAlgorithms();
      });
    </script>
  </body>
</html>
